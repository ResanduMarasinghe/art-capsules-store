rules_version = '2';
service cloud.firestore {
  function isSignedIn() {
    return request.auth != null;
  }

  function isAdminUser() {
    return isSignedIn() && (
      request.auth.token.admin == true || (
        request.auth.token.email != null &&
        exists(/databases/$(database)/documents/adminSettings/core) &&
        get(/databases/$(database)/documents/adminSettings/core).data.keys().hasAny(['allowedEmails']) &&
        get(/databases/$(database)/documents/adminSettings/core).data.allowedEmails.hasAny([
          request.auth.token.email
        ])
      )
    );
  }

  match /databases/{database}/documents {
    match /capsules/{docId} {
      allow read: if true; // or lock down as needed
      allow write: if isSignedIn();
    }

    match /orders/{docId} {
      allow create: if true; // storefront checkouts run unauthenticated
      allow read: if isSignedIn(); // admin dashboard reads after sign-in
      allow update, delete: if isAdminUser();
    }

    match /metadata/capsulesCounter {
      allow read, write: if isSignedIn();
    }

    match /collectorEmails/{docId} {
      allow create: if true;
      allow read: if isSignedIn();
      allow update, delete: if isAdminUser();
    }

    match /promoCodes/{docId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    match /adminSettings/{docId} {
      allow read, write: if isAdminUser();
    }

    match /tags/{docId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
  }
}
