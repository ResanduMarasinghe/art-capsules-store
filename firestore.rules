rules_version = '2';
service cloud.firestore {
  function isSignedIn() {
    return request.auth != null;
  }

  function isAdminUser() {
    return isSignedIn() && (
      request.auth.token.admin == true || (
        request.auth.token.email != null &&
        exists(/databases/$(database)/documents/adminSettings/core) &&
        get(/databases/$(database)/documents/adminSettings/core).data.keys().hasAny(['allowedEmails']) &&
        get(/databases/$(database)/documents/adminSettings/core).data.allowedEmails.hasAny([
          request.auth.token.email
        ])
      )
    );
  }

  match /databases/{database}/documents {
    match /capsules/{docId} {
      allow read: if true; // storefront needs to read capsule catalog
      allow create, delete: if isSignedIn();
      allow update: if isSignedIn() || isPublicStatsIncrement();
    }

    match /orders/{docId} {
      allow create: if true; // storefront checkouts run unauthenticated
      allow read: if isSignedIn(); // admin dashboard reads after sign-in
      allow update, delete: if isAdminUser();
    }

    match /metadata/capsulesCounter {
      allow read, write: if isSignedIn();
    }

    match /collectorEmails/{docId} {
      allow create: if true;
      allow read: if isSignedIn();
      allow update, delete: if isAdminUser();
    }

    match /promoCodes/{docId} {
      allow read: if true;
      allow write: if isAdminUser();
    }

    match /adminSettings/{docId} {
      allow read, write: if isAdminUser();
    }

    match /tags/{docId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
  }
}

function isPublicStatsIncrement() {
  return request.auth == null &&
    request.resource.data.diff(resource.data).changedKeys().hasOnly(['stats']) &&
    statsOnlyIncrease('views') &&
    statsOnlyIncrease('addedToCart') &&
    statsOnlyIncrease('purchases');
}

function statsOnlyIncrease(field) {
  return (!resource.data.stats[field] && !request.resource.data.stats[field]) ||
    (request.resource.data.stats[field] >= resource.data.stats[field]);
}
